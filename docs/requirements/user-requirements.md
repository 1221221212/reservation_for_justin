# ユーザー要件定義

システムを利用する各ユーザー（顧客、スタッフ、店長、オーナー）ごとに、「どんな画面・機能が必要か」「何を入力・確認したいか」を整理したものです。  
各ロールは「大は小を兼ねる」階層構造を持ち、上位ロールは下位ロールのユースケースをすべて含みます。

---

## 1. 顧客（Customer）

1. **UC01-1 店舗一覧を閲覧する**  
   - 地図やリスト形式で全店舗を表示し、名称・住所・営業時間・席タイプ（禁煙・喫煙、個室・テーブル・カウンターなど）を確認する。

2. **UC01-2 来店希望の店舗を選択する**  
   - 目的の店舗をクリックまたはタップし、店舗詳細画面へ移動する。

3. **UC01-3 席タイプを選択する**  
   - 「禁煙／喫煙」「個室／テーブル／カウンター」などから希望席タイプを選択し、空き状況を絞り込む。

4. **UC01-4 空席状況を確認しコースを選択する**  
   - 選択した店舗・席タイプにおける空き日時をカレンダーやタイムスロット形式で確認し、「コース（席のみプラン含む）」を選択する。

5. **UC01-5 新規予約を申し込む**  
   - 選択済みの日時・人数・コース・席タイプを確認後、名前・メールアドレス・電話番号（任意）・コメント（任意）を入力し、最終確認モーダルを経て予約を確定する。

6. **UC01-6 予約完了画面を確認しメール通知を受け取る**  
   - 画面に予約ID・店舗名・来店日時・人数・コース・席タイプ・受付番号を表示し、キャンセル用URLを含む自動送信メールが届く。

7. **UC01-7 予約の詳細をマイページまたはメールで確認する**  
   - マイページ（顧客向け機能がある場合）や送信されたメールから「現在の予約内容（店舗・日時・人数・コース・席タイプ）」を確認できる。

8. **UC01-8 メールのキャンセルリンクから予約をキャンセルする**  
   - メール内の一意な「キャンセル用URL」をクリックしてアクセスし、予約内容を表示して「本当にキャンセルするか」を確認。「はい」を押すとキャンセル完了し、店舗へLINE・メール通知が行われる。

9. **UC01-9 メールの変更リンクから予約情報を修正する**  
   - メールに含めた「変更用URL」をクリックし、予約ページを開いて日時・人数・コース・席タイプ・コメントを再設定し、空席チェック後に更新。完了後、顧客へメール・店舗へLINE通知が行われる。

10. **UC01-10 キャンセル後に再予約ページへ誘導される**  
    - キャンセル完了後、同じ店舗の再予約フォームへ誘導するリンクを表示する。

### 1.2 要件・バリデーション
- 名前・メールアドレスは必須（メールは RFC 準拠）。  
- 来店日時は未来日時かつ店舗の営業時間内（定休日を除外）。  
- 来店人数は 1～店舗最大席数の範囲。  
- 電話番号は任意、数字のみ（例：09012345678）。  
- コメントは任意、最大200文字。  
- 予約操作後、必ず顧客にメール通知が届くこと（SendGrid 等を利用）。  
- 変更リンク・キャンセルリンクは一意のトークン付き URL とし、有効期限を設定する。  

---

## 2. 一般スタッフ（Staff）

> **含む対象**：スタッフは「顧客」ユースケースを行わず、以下の操作のみを実行できる。  
> **注意**：店長・オーナーの機能は含まず、あくまでスタッフ固有のユースケース。

1. **UC02-1 ログインする**  
   - メールアドレス＋パスワードで認証し、JWT トークンを取得する。  
   - 成功後、自店舗の予約データにアクセス可能になる。

2. **UC02-2 当日の予約一覧を表示する**  
   - 当日の予約のみをテーブル形式で一覧表示。  
   - テーブル列：予約ID、顧客名、来店日時、人数、コース、席タイプ、ステータス、コメント。  
   - 当日分の「空席数」や「残席数」を行単位で確認可能。  

3. **UC02-3 当日の予約詳細を確認する**  
   - 任意の当日予約を選択し、詳細（コース・席タイプ・顧客情報など）を表示する。

4. **UC02-4 当日の予約を変更する**  
   - 予約の来店日時・人数・コース・席タイプ・コメントを再設定し、空席チェック後に更新する。  
   - 更新完了後、顧客へメール通知、店舗へLINE通知を行う。

5. **UC02-5 当日の予約をキャンセルする**  
   - 予約をキャンセルし、ステータスを `CANCELLED` に更新。  
   - キャンセル理由を入力でき、完了後に顧客へメール・店舗へLINE通知を行う。  

6. **UC02-6 任意期間の予約を検索する**  
   - 期間制限なしで、自店舗の過去・未来すべての予約を絞り込む。  
   - 検索フィルタ：顧客名／メールアドレス／電話番号、予約ステータス（確定／キャンセル／NOSHOW）、期間指定（日付範囲）、コース名、席タイプ（禁煙・喫煙、個室・テーブル・カウンターなど）。  

7. **UC02-7 検索結果から予約詳細を確認する**  
   - 検索結果の任意の予約をクリックし、詳細を表示する。  

8. **UC02-8 検索結果から予約を変更する**  
   - 予約詳細同様の手順で、変更を行い空席チェック後に更新する。  

9. **UC02-9 検索結果から予約をキャンセルする**  
   - 同様にステータスを `CANCELLED` に更新し、キャンセル理由を入力。  

10. **UC02-10 新規に電話予約やSNS予約を手動で登録する**  
    - 電話やSNSで受けた予約をシステム上で「新規予約」として登録するフォームを利用。  
    - 顧客情報、日時、人数、コース、席タイプ、メモ欄を入力して登録。  

11. **UC02-11 当日来店したウォークイン客を「当日追加予約」として登録する**  
    - ウォークイン客用の簡易フォームで「当日予約」を登録。  
    - 席タイプを選択し、空席チェック後に即時確定する。  

12. **UC02-12 ノーショー客のステータス更新を行う**  
    - 予約時間経過後、自動的にあるいは手動でステータスを `NOSHOW` に更新。  
    - 手動設定時、理由メモを残せるようにする。

13. **UC02-13 顧客からの連絡（電話・SNS）を予約システム上にメモとして記録する**  
    - 各予約に紐づくコメント欄に「電話で△△と言われた」「アレルギーあり」といったメモを残す。  

14. **UC02-14 自店舗のカレンダー表示で予約状況を可視化する**  
    - 月表示／週表示で空席数・予約数・席タイプ別利用状況をバッジで可視化。  
    - **UC02-14-1** 月表示／週表示で空席数・予約数を視覚化する。  
    - **UC02-14-2** ドラッグ＆ドロップで、指定日時・席タイプ間で予約枠の移動・変更を行える。  

### 2.2 要件・バリデーション
- スタッフは自店舗のデータのみ閲覧・操作可能。  
- 変更後の来店日時・人数・コース・席タイプは空席チェックを通過すること。  
- キャンセルは当日23:59まで可能。  
- 変更・キャンセル後、必ず顧客へメール、店舗へLINE通知が行われる。  
- テーブルや検索フィルタの入力は SQL インジェクションを防ぐためエスケープ処理を行う。  
- コース・席タイプ一覧は店長が設定したマスターデータを参照する。  
- カレンダー表示の操作中に空席数が不足した場合はエラーを表示し、変更をキャンセルできる。  

---

## 3. 店長（Manager）

> **含む：** 上記スタッフの UC02-1～UC02-14 をすべて含む（大は小を兼ねる）。

1. **UC03-1 自店舗の基本情報を編集する**  
   - 店舗名、住所、電話番号、イメージ画像、紹介文、SNSリンクなどを登録・変更する。  

2. **UC03-2 営業日カレンダーを編集する**  
   - **UC03-2-1** 定常営業時間（日～土）を登録・変更する。  
   - **UC03-2-2** 定休日を登録・変更する。  
   - **UC03-2-3** 臨時営業日を登録・変更する。  
   - **UC03-2-4** 臨時休業日を登録・変更する。  

3. **UC03-3 予約受付ポリシーを設定する**  
   - **UC03-3-1** 受付開始日（何日前から予約を受け付けるか）を設定する。  
   - **UC03-3-2** 受付締切日（何日前までキャンセルを受け付けるか）を設定する。  

4. **UC03-4 店舗レイアウト／席数を設定する**  
   - **UC03-4-1** テーブル名・タイプ（小上がり／個室／テーブル／カウンター）を登録する。  
   - **UC03-4-2** 各テーブルの座席数を設定する。  
   - **UC03-4-3** 席タイプごとの配置図を登録し、空席計算に利用する。  

5. **UC03-5 コース情報を管理する**  
   - **UC03-5-1** コース名・価格・説明を登録・変更する。  
   - **UC03-5-2** コースごとの最小／最大利用人数を設定する。  
   - **UC03-5-3** コース提供時間（所要分数）を設定する。  

6. **UC03-6 予約枠（タイムスロット）を設定する**  
   - **UC03-6-1** 日別・時間帯別の枠数を登録する。  
   - **UC03-6-2** 繁閑期調整ルール（自動増減）を設定する（オプション）。  
   - **UC03-6-3** 特別イベント・貸切日の予約受付停止を設定する。  

7. **UC03-7 予約データの CSV エクスポート（当日分・任意期間）を実行する**  
   - 当日および期間指定で予約一覧を CSV 形式でダウンロードできる。  

8. **UC03-8 売上予測（コース×人数の当日分）を確認する**  
   - 当日分の売上予測をリアルタイムに表示する。  

9. **UC03-9 自店舗の売上予測レポートを確認する**  
   - **UC03-9-1** コース別／席タイプ別売上想定をグラフ表示する。  
   - **UC03-9-2** 期間指定して売上予測を CSV エクスポートする。  

10. **UC03-10 自店舗の予約データ分析を行う**  
    - **UC03-10-1** 月間予約件数推移を確認する。  
    - **UC03-10-2** キャンセル率・ノーショー率を確認する。  
    - **UC03-10-3** 来店人数分布を確認する。  
    - **UC03-10-4** コース別・席タイプ別利用比率を確認する。  

11. **UC03-11 自店舗のカレンダー表示で予約状況を可視化する**  
    - **UC03-11-1** 月表示／週表示で空席数・予約数を視覚化する。  
    - **UC03-11-2** ドラッグ＆ドロップで予約枠の移動・変更を行う。  

12. **UC03-12 予約ログ（変更履歴・キャンセル理由など）を確認する**  
    - 過去の予約変更・キャンセル履歴を一覧表示できる。  

13. **UC03-13 予約通知トラブル時、手動で通知再送を実行する**  
    - 顧客／店舗向けに失敗したメール・LINE 通知を手動で再送する。  

14. **UC03-14 店舗スタッフの一覧を閲覧する**  
    - 店舗スタッフの名前・メールアドレス・ロール・ステータス・最終ログイン日時を一覧表示する。  
    - （アカウントの作成・削除・権限変更はオーナーのみ行う）

15. **UC03-15 コースごとの材料リストを設定する**  
    - コースごとに必要な材料（食材やドリンクなど）とその標準使用量を登録・変更できる。  
    - 材料は「材料名」「単位（g, 個, 本 など）」「1コースあたり使用量」などで管理し、コースマスタと紐づく。

16. **UC03-16 発注予測レポートを確認する**  
    - 予約数とコース設定に基づき、所定期間（当日〜翌週など）に必要となる材料の総量を計算して表示する。  
    - 期間指定（日付範囲）で、各材料の発注推奨量（発注リードタイムを考慮した安全在庫含む）をグラフ／テーブルで出力し、CSVダウンロードできる。

### 3.2 要件・バリデーション
- 店長は自店舗のすべての管理機能にアクセス可能。  
- 受付ポリシー設定時、開始日 < 終了日を必ず満たすこと。  
- 席数・レイアウト登録時、座席数は正の整数であること。  
- コース登録時、価格は0以上、コース名は2～50文字。  
- 予約枠管理時、設定したタイムスロットの合計席数は店舗全体の最大席数を超えないこと。  
- CSV フィルタ（日付範囲・コース・席タイプなど）は正しい形式であること。  
- 通知再送時、テンプレート変更後にプレビュー機能を提供する。  
- **UC03-15** において、材料マスタの重複チェックを行うこと。  
- **UC03-16** は発注リードタイムおよび安全在庫を考慮した計算が必要。  

---

## 4. オーナー（Owner）

> **含む：** 上記 Manager の UC02-1～UC03-16 をすべて含む

1. **UC04-1 全店舗の一覧を表示する**  
   - 全 20 店舗をリストまたはカード形式で表示し、名称・住所・営業時間・ステータス（公開／非公開）などを確認できる。

2. **UC04-2 新規店舗を追加する**  
   - 店舗名・住所・電話番号・イメージ画像・紹介文・SNSリンクなどを入力して登録する。

3. **UC04-3 既存店舗を編集・削除する**  
   - 店舗情報を変更・更新、または店舗をリポジトリ上から削除できる。  

4. **UC04-4 全ユーザーアカウントを管理する**  
   - **UC04-4-1** 店長アカウントの作成・編集・削除。  
   - **UC04-4-2** スタッフアカウントの作成・編集・削除。  
   - **UC04-4-3** 自身（オーナー）アカウントの管理（権限変更／ロックアウト）。  

5. **UC04-5 全店舗のダッシュボードを確認する**  
   - **UC04-5-1** 期間・店舗フィルタで予約件数推移をグラフ表示する。  
   - **UC04-5-2** キャンセル率／ノーショー率をグラフ表示（複数店舗比較可）。  
   - **UC04-5-3** 店舗別予約ランキング（上位／下位）を表示する。  
   - **UC04-5-4** コース別・席タイプ別売上想定をテーブル表示し、CSV 出力できる。  

6. **UC04-6 全店舗の予約通知ログを確認する**  
   - **UC04-6-1** 通知（メール・LINE）のステータス（成功／失敗）を一覧表示する。  
   - **UC04-6-2** 失敗した通知を手動で再送する。  
   - **UC04-6-3** 通知テンプレート（メール件名・本文、LINE メッセージ本文）を編集する。  

7. **UC04-7 システム全体設定を更新する**  
   - **UC04-7-1** サーバー通知設定（SendGrid API キー、LINE チャネル設定）を更新する。  
   - **UC04-7-2** 共通利用規約やプライバシーポリシー文言を更新する。  
   - **UC04-7-3** システムメンテナンススケジュールを管理し、全店舗にメンテナンス通知を行う。  

### 4.2 要件・バリデーション
- オーナーはすべての店舗・すべてのアカウント情報にアクセス可能。  
- 店舗追加時、必ず「店舗名」「住所」「電話番号」を必須入力する。  
- アカウント作成時、メールアドレスはユニークチェックを行う。  
- ダッシュボードのフィルタは開始日 < 終了日をチェックし、妥当な期間か確認する。  
- CSV エクスポート時、選択した出力カラム・期間のバリデーションを行う。  
- テンプレート編集時、プレビュー機能で実際の置換結果を確認できる。  

---

## 5. 共通（All Users）

### 5.1 認証・権限管理
- **JWT トークン方式** でセッション管理（アクセストークン有効期限15分、Refresh Token 方式を採用）。  
- **Nest.js の Guard（RolesGuard）** によるエンドポイント単位のロールチェックを実装。  
- 未ログインユーザーはスタッフ／店長／オーナー画面にアクセス不可。  
- ログイン失敗時には一定回数以上でアカウントロックを実施可能。  

### 5.2 通知
- 予約作成・変更・キャンセル時に以下を実行：  
  1. 顧客に **メール通知（SendGrid 経由）**  
  2. 店舗に **メール・LINE 通知（SendGrid／LINE Messaging API 依存）**  
- 通知ジョブは **Redis + Bull** でキュー化し、非同期に処理。  
- 通知失敗時は最大3回リトライし、それでも失敗した場合は「通知ログ画面」から手動再送可能。  

### 5.3 共通バリデーション
- **メール**：RFC5322 準拠のフォーマットチェック。  
- **電話番号**：数字のみ、ハイフンなし（10～11桁）。  
- **テキスト入力**：XSS 攻撃を防ぐため、すべての動的コンテンツはサニタイズ（DOMPurify など）またはエスケープ処理を行う。  
- すべての **POST/PUT リクエスト** は **class-validator** を用いて必須・フォーマットチェックを実行。  

### 5.4 ログ\/監査
- すべての **API アクセスログ** を出力（リクエストパス・メソッド・ステータス・実行時間）。  
- エラー発生時はスタックトレースを含む詳細ログを保存（ログレベルは `ERROR`）。  
- ログはデフォルトで 90 日間保持し、それを超えたものは自動的に削除する設定とする。  
